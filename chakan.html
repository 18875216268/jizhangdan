<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÁîüÊ¥ª¬∑ËÆ∞Ë¥¶Âçï</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f9f9f9;
            color: #333;
        }

        .top-bar {
            position: fixed;
            top: 0;
            width: 100%;
            background-color: #4CAF50;
            color: white;
            text-align: center;
            padding: 10px 0;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        #top-title {
            font-weight: bold;
            font-size: 16px;
        }

        .top-bar img {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 24px;
            height: 24px;
            cursor: pointer;
        }

        .bottom-bar {
            position: fixed;
            bottom: 0;
            width: 100%;
            background-color: #4CAF50;
            color: white;
            text-align: center;
            padding: 5px 0;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: flex;
            justify-content: space-around;
        }

        .bottom-bar-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
        }

        .bottom-bar img {
            width: 20px;
            height: 20px;
        }

        .bottom-bar span {
            font-size: 10px;
            margin-top: 2px;
        }

        .content {
            padding: 60px 10px 80px;
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 10px;
            justify-content: space-between;
        }

        .jilu {
            background: #fff;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            font-size: 12px;
        }

        .jilu h3 {
            margin-top: 10px;
            font-size: 14px;
            color: #4CAF50;
        }

        .jilu.completed h3 {
            color: #f44336;
        }

        .jilu p {
            font-size: 12px;
            margin-bottom: 5px;
        }

        .settings-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
        }

        .delete-btn {
            position: absolute;
            top: 10px;
            right: 40px;
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
        }

        table {
            width: 100%;
            table-layout: fixed;
            border-collapse: collapse;
            border-spacing: 0;
        }

        table th,
        table td {
            border: 1px solid #ddd;
            padding: 5px;
            text-align: center;
            overflow: hidden;
            white-space: nowrap;
            font-size: 12px;
        }

        table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }

        table th:nth-child(3),
        table td:nth-child(3) {
            width: 35px;
        }

        table th:nth-child(4),
        table td:nth-child(4) {
            width: 50px;
        }

        table th:nth-child(2),
        table td:nth-child(2) {
            width: 80px;
        }

        table td div {
            overflow-x: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
            white-space: nowrap;
        }

        table td div::-webkit-scrollbar {
            display: none;
        }

        .remark {
            color: #666;
            font-size: 12.5px;
            margin-top: 5px;
        }

        .search-popup, .delete-confirm-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            padding: 20px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            display: none;
            z-index: 1100;
            width: calc(100% - 80px);
            max-width: 400px;
        }

        .search-popup-content, .delete-confirm-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            flex-wrap: nowrap;
        }

        .search-input {
            flex: 1;
            padding: 10px;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 5px;
            outline: none;
            width: 90%;
        }

        .search-button-confirm, .delete-button-confirm {
            padding: 10px;
            font-size: 14px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            width: 60px;
            flex-shrink: 0;
            background-color: #4CAF50;
            color: white;
            transition: background-color 0.3s ease;
        }

        .search-button-confirm:hover, .delete-button-confirm:hover {
            background-color: #45a049;
        }

        .search-button-cancel, .delete-button-cancel {
            padding: 10px;
            font-size: 14px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            width: 60px;
            flex-shrink: 0;
            background-color: #f44336;
            color: white;
            transition: background-color 0.3s ease;
        }

        .search-button-cancel:hover, .delete-button-cancel:hover {
            background-color: #e53935;
        }

        .search-title, .delete-confirm-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1099;
            display: none;
        }

        @media (max-width: 768px) {
            .content {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
        }

        @media (max-width: 480px) {
            .content {
                grid-template-columns: 1fr;
            }
        }

        .notification {
            position: fixed;
            right: 20px;
            bottom: 60px;
            background-color: #4CAF50;
            color: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.4s ease, transform 0.4s ease;
            z-index: 1500;
        }

        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>

<body>
    <div class="top-bar" id="top-title">
        ÁîüÊ¥ª‰∫∫¬∑ËÆ∞ÂΩï
        <img src="zhuye.png" alt="‰∏ªÈ°µ" onclick="location.href='index.html'">
    </div>

    <div class="content" id="records">
        <p>Âä†ËΩΩ‰∏≠...</p>
    </div>

    <div class="bottom-bar">
        <div class="bottom-bar-item" id="toggle-bar" onclick="toggleCompletedRecords()">
            <img src="qiehuan.png" alt="ÂàáÊç¢" id="toggle-icon">
            <span id="toggle-text">ÂàáÊç¢</span>
        </div>
        <div class="bottom-bar-item" id="search-bar" onclick="toggleSearch()">
            <img src="sousuo.png" alt="ÊêúÁ¥¢" id="search-icon">
            <span id="search-text">ÊêúÁ¥¢</span>
        </div>
        <div class="bottom-bar-item" onclick="location.href='tongji.html'">
            <img src="tongji.png" alt="ÁªüËÆ°">
            <span>ÁªüËÆ°</span>
        </div>
        
    </div>

    <div class="overlay" id="overlay"></div>
    <div class="search-popup" id="search-popup">
        <div class="search-popup-content" style="flex-direction: column; align-items: center;">
            <div class="search-title">ÊÇ®Â•ΩÔºåÁîüÊ¥ª‰∫∫ÔºÅ</div>
            <input type="text" id="search-input" class="search-input" placeholder="ËØ∑ËæìÂÖ•ÊêúÁ¥¢ÂÖ≥ÈîÆÂ≠ó">
            <div style="display: flex; gap: 20px; margin-top: 10px;">
                <button onclick="closeSearchPopup()" class="search-button-cancel">ÂèñÊ∂à</button>
                <button onclick="performSearch()" class="search-button-confirm">Á°ÆËÆ§</button>
            </div>
        </div>
    </div>

    <div class="delete-confirm-popup" id="delete-confirm-popup">
        <div class="delete-confirm-content" style="flex-direction: column; align-items: center;">
            <div class="delete-confirm-title">Á°ÆËÆ§Âà†Èô§Ê≠§Êù°ËÆ∞ÂΩïÔºü</div>
            <div style="display: flex; gap: 20px; margin-top: 10px;">
                <button onclick="closeDeletePopup()" class="delete-button-cancel">ÂèñÊ∂à</button>
                <button onclick="confirmDelete()" class="delete-button-confirm">Á°ÆËÆ§</button>
            </div>
        </div>
    </div>

    <div class="notification" id="notification">ËÆ∞ÂΩïÂ∑≤ÈöêËóèÔºÅ</div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB-pZD5Mb8pejzBr3ZuHoFkJipzSWLJCpo",
            authDomain: "jizhang-2e89a.firebaseapp.com",
            databaseURL: "https://jizhang-2e89a-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "jizhang-2e89a",
            storageBucket: "jizhang-2e89a.firebasestorage.app",
            messagingSenderId: "849349607897",
            appId: "1:849349607897:web:e0eb3a2222cac60d3b99c8",
            measurementId: "G-SYL25YT9ZC"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const recordsDiv = document.getElementById("records");
        let allRecords = [];
        let showingCompleted = false;
        let isSearching = false;
        let currentRecordToDelete = null;

        function updateRecordState(recordId) {
            database.ref(`expenses/${recordId}`).once('value', (snapshot) => {
                const record = snapshot.val();
                const newState = record.state === "Êú™ÂÆåÊàê" ? "Â∑≤ÂÆåÊàê" : "Êú™ÂÆåÊàê";
                database.ref(`expenses/${recordId}`).update({ state: newState })
                    .then(() => {
                        // Ê†πÊçÆÂΩìÂâçÊòæÁ§∫Áä∂ÊÄÅÂÜ≥ÂÆöÊèêÁ§∫ÊñáÂ≠ó
                        const message = showingCompleted ? "ËÆ∞ÂΩïÂ∑≤ÊÅ¢Â§çÔºÅ" : "ËÆ∞ÂΩïÂ∑≤ÈöêËóèÔºÅ";
                        showNotification(message);
                        
                        // Êõ¥Êñ∞ allRecords ‰∏≠ÁöÑËÆ∞ÂΩïÁä∂ÊÄÅ
                        allRecords = allRecords.map(([id, r]) => {
                            if (id === recordId) {
                                return [id, { ...r, state: newState }];
                            }
                            return [id, r];
                        });
                        
                        // Ê†πÊçÆÂΩìÂâçÊòæÁ§∫Áä∂ÊÄÅËøáÊª§Âπ∂Ê∏≤ÊüìËÆ∞ÂΩï
                        const filteredRecords = showingCompleted
                            ? allRecords.filter(([, r]) => r.state === "Â∑≤ÂÆåÊàê")
                            : allRecords.filter(([, r]) => r.state !== "Â∑≤ÂÆåÊàê");
                        renderRecords(filteredRecords);
                    })
                    .catch((error) => {
                        console.error("Êõ¥Êñ∞ËÆ∞ÂΩïÊó∂ÂèëÁîüÈîôËØØ: ", error);
                    });
            });
        }

        function showDeleteConfirm(recordId) {
            currentRecordToDelete = recordId;
            document.getElementById("delete-confirm-popup").style.display = "block";
            document.getElementById("overlay").style.display = "block";
        }

        function closeDeletePopup() {
            document.getElementById("delete-confirm-popup").style.display = "none";
            document.getElementById("overlay").style.display = "none";
            currentRecordToDelete = null;
        }

        function confirmDelete() {
            if (currentRecordToDelete) {
                database.ref(`expenses/${currentRecordToDelete}`).remove()
                    .then(() => {
                        showNotification("ËÆ∞ÂΩïÂ∑≤Âà†Èô§ÔºÅ");
                        // ‰ªéallRecords‰∏≠ÁßªÈô§Â∑≤Âà†Èô§ÁöÑËÆ∞ÂΩï
                        allRecords = allRecords.filter(([id]) => id !== currentRecordToDelete);
                        // ÈáçÊñ∞Ê∏≤ÊüìËÆ∞ÂΩï
                        const filteredRecords = showingCompleted
                            ? allRecords.filter(([, r]) => r.state === "Â∑≤ÂÆåÊàê")
                            : allRecords.filter(([, r]) => r.state !== "Â∑≤ÂÆåÊàê");
                        renderRecords(filteredRecords);
                        closeDeletePopup();
                    })
                    .catch((error) => {
                        console.error("Âà†Èô§ËÆ∞ÂΩïÊó∂ÂèëÁîüÈîôËØØ: ", error);
                    });
            }
        }

        function showNotification(message) {
            const notification = document.getElementById("notification");
            notification.textContent = message;
            notification.classList.add("show");
            setTimeout(() => {
                notification.classList.remove("show");
            }, 3000);
        }

        database.ref("expenses").on("value", (snapshot) => {
            const records = snapshot.val();
            if (!records) {
                recordsDiv.innerHTML = "<p>ÊöÇÊó†Êï∞ÊçÆ„ÄÇ</p>";
                return;
            }

            // Ëé∑ÂèñÊâÄÊúâËÆ∞ÂΩïÂπ∂ÊåâÊó•ÊúüÊéíÂ∫è
            allRecords = Object.entries(records)
                .sort(([, a], [, b]) => {
                    return new Date(b.date) - new Date(a.date);
                });

            // Â¶ÇÊûú‰∏çÊòØÂú®ÊêúÁ¥¢Áä∂ÊÄÅÔºåÂàôÊ†πÊçÆÂΩìÂâçÊòæÁ§∫Áä∂ÊÄÅËøáÊª§ËÆ∞ÂΩï
            if (!isSearching) {
                const filteredRecords = showingCompleted
                    ? allRecords.filter(([, record]) => record.state === "Â∑≤ÂÆåÊàê")
                    : allRecords.filter(([, record]) => record.state !== "Â∑≤ÂÆåÊàê");
                renderRecords(filteredRecords);
            }
        });

        function toggleCompletedRecords() {
            isSearching = false; // ÈáçÁΩÆÊêúÁ¥¢Áä∂ÊÄÅ
            const toggleIcon = document.getElementById("toggle-icon");
            const toggleText = document.getElementById("toggle-text");
            showingCompleted = !showingCompleted;

            // ÈáçÁΩÆÊêúÁ¥¢UI
            const searchIcon = document.getElementById("search-icon");
            const searchText = document.getElementById("search-text");
            searchIcon.src = "sousuo.png";
            searchText.innerText = "ÊêúÁ¥¢";

            if (showingCompleted) {
                toggleIcon.src = "quxiao.png";
                toggleText.innerText = "ÂèñÊ∂à";
                const completedRecords = allRecords.filter(([, record]) => record.state === "Â∑≤ÂÆåÊàê");
                renderRecords(completedRecords);
            } else {
                toggleIcon.src = "qiehuan.png";
                toggleText.innerText = "ÂàáÊç¢";
                const incompleteRecords = allRecords.filter(([, record]) => record.state !== "Â∑≤ÂÆåÊàê");
                renderRecords(incompleteRecords);
            }
        }

        function renderRecords(records) {
    recordsDiv.innerHTML = "";
    if (records.length === 0) {
        recordsDiv.innerHTML = "<p>ÊöÇÊó†Êï∞ÊçÆ„ÄÇ</p>";
        return;
    }

    // Ëé∑ÂèñÂΩìÂ§©Êó•ÊúüÁöÑ yyyy/mm/dd Ê†ºÂºè
    const today = new Date();
    const todayString = `${today.getFullYear()}/${String(today.getMonth() + 1).padStart(2, '0')}/${String(today.getDate()).padStart(2, '0')}`;

    records.forEach(([id, record]) => {
        const totalMoney = parseFloat(record.money);
        const avgMoney = (totalMoney / parseInt(record.number)).toFixed(2);
        const participants = record.namegive.split(",");

        let tableHTML = `
            <table>
                <tr>
                    <th>ÂàÜÊëä‰∫∫</th>
                    <th>ÂàÜÊëäÈáëÈ¢ù</th>
                    <th>ÊîØ‰ªò</th>
                    <th>‰ªòÊ¨æ‰∫∫</th>
                </tr>
                <tr>
                    <td><div>${participants.join(",")}</div></td>
                    <td><div>${avgMoney}ÂÖÉ</div></td>
                    <td><div>‚Üí</div></td>
                    <td><div>${record.name}</div></td>
                </tr>
            </table>
        `;

        const recordElement = document.createElement("div");
        recordElement.classList.add("jilu");
        if (record.state === "Â∑≤ÂÆåÊàê") {
            recordElement.classList.add("completed");
        }

        // ÊèêÂèñËÆ∞ÂΩïÊó•ÊúüÁöÑ yyyy/mm/dd ÈÉ®ÂàÜÂπ∂Âà§Êñ≠ÊòØÂê¶‰∏éÂΩìÂ§©Êó•ÊúüÂåπÈÖç
        const recordDate = record.date.split(" ")[0];
        const dateStyle = recordDate !== todayString ? "style='color: red;'" : "";

        let buttonsHTML = `<button class="settings-btn" onclick="updateRecordState('${id}')">üîñ</button>`;
        
        // Âè™Âú®ÊòæÁ§∫Â∑≤ÂÆåÊàêËÆ∞ÂΩïÊó∂Ê∑ªÂä†Âà†Èô§ÊåâÈíÆ
        if (showingCompleted && record.state === "Â∑≤ÂÆåÊàê") {
            buttonsHTML = `
                <button class="settings-btn" onclick="updateRecordState('${id}')">üîñ</button>
                <button class="delete-btn" onclick="showDeleteConfirm('${id}')">‚õî</button>
            `;
        }

        recordElement.innerHTML = `
            ${buttonsHTML}
            <h3 ${dateStyle}>${record.date}</h3>
            <p>‚Üí ${record.name}: ${totalMoney}ÂÖÉÔºà${record.what || "Êó†ËØ¥Êòé"}Ôºâ</p>
            ${tableHTML}
            <p class="remark">Â§áÊ≥®: ${record.why || "Êó†Â§áÊ≥®"}</p>
        `;
        recordsDiv.appendChild(recordElement);
    });
}

        function toggleSearch() {
            const searchIcon = document.getElementById("search-icon");
            const searchText = document.getElementById("search-text");
            if (searchText.innerText === "ÊêúÁ¥¢") {
                document.getElementById("search-popup").style.display = "block";
                document.getElementById("overlay").style.display = "block";
            } else {
                isSearching = false;
                searchText.innerText = "ÊêúÁ¥¢";
                searchIcon.src = "sousuo.png";
                // ÈáçÊñ∞Ê∏≤ÊüìËÆ∞ÂΩïÊó∂ÈúÄË¶ÅËÄÉËôëÂΩìÂâçÁöÑÊòæÁ§∫Áä∂ÊÄÅ
                const filteredRecords = showingCompleted
                    ? allRecords.filter(([, record]) => record.state === "Â∑≤ÂÆåÊàê")
                    : allRecords.filter(([, record]) => record.state !== "Â∑≤ÂÆåÊàê");
                renderRecords(filteredRecords);
            }
        }

        function closeSearchPopup() {
            document.getElementById("search-popup").style.display = "none";
            document.getElementById("overlay").style.display = "none";
        }

        function performSearch() {
            const keyword = document.getElementById("search-input").value.trim().toLowerCase();
            if (keyword) {
                isSearching = true;

                // È¶ñÂÖàÊ†πÊçÆÂΩìÂâçÊòæÁ§∫Áä∂ÊÄÅ(ÂÆåÊàê/Êú™ÂÆåÊàê)ËøáÊª§ËÆ∞ÂΩï
                let searchableRecords = showingCompleted
                    ? allRecords.filter(([, record]) => record.state === "Â∑≤ÂÆåÊàê")
                    : allRecords.filter(([, record]) => record.state !== "Â∑≤ÂÆåÊàê");

                // Âú®ËøáÊª§ÂêéÁöÑËÆ∞ÂΩï‰∏≠ÊêúÁ¥¢ÊåáÂÆöÂ≠óÊÆµ
                const filteredRecords = searchableRecords.filter(([, record]) => {
                    // Ê£ÄÊü•ÂêÑ‰∏™Â≠óÊÆµÊòØÂê¶ÂåÖÂê´ÊêúÁ¥¢ÂÖ≥ÈîÆÂ≠ó
                    const avgMoney = (parseFloat(record.money) / parseInt(record.number)).toFixed(2);
                    return [
                        record.date,
                        record.name,
                        record.namegive,
                        record.money,
                        avgMoney,
                        record.what || "",
                        record.why || ""
                    ].some(field =>
                        field.toString().toLowerCase().includes(keyword)
                    );
                });

                renderRecords(filteredRecords);
                document.getElementById("search-icon").src = "quxiao.png";
                document.getElementById("search-text").innerText = "ÂèñÊ∂à";
            }
            closeSearchPopup();
        }
    </script>
</body>

</html>
