<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”Ÿæ´»äººÂ·è®°å½•</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <!-- CSS ç¾åŒ– -->
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f9f9f9;
            color: #333;
        }
        /* é¡¶éƒ¨æ ‡é¢˜æ æ ·å¼ */
        .top-bar {
            position: fixed;
            top: 0;
            width: 100%;
            background-color: #4CAF50;
            color: white;
            text-align: center;
            padding: 10px 0;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        #top-title{
            font-weight: bold;
        }


        /* å³ä¾§å›¾æ ‡æ ·å¼ */
        .top-bar img {
            position: absolute;
            right: 20px; /* è·ç¦»å³ä¾§20px */
            top: 50%; /* å‚ç›´å±…ä¸­ */
            transform: translateY(-50%);
            width: 24px; /* å›¾æ ‡å®½åº¦ */
            height: 24px; /* å›¾æ ‡é«˜åº¦ */
            cursor: pointer; /* é¼ æ ‡æ‚¬åœä¸ºæ‰‹å‹ */
        }
        /* åº•éƒ¨å¯¼èˆªæ æ ·å¼ */
        .bottom-bar {
            position: fixed;
            bottom: 0;
            width: 100%;
            background-color: #4CAF50;
            color: white;
            text-align: center;
            padding: 5px 0;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: flex;
            justify-content: space-around;
        }
        .bottom-bar-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
        }
        .bottom-bar img {
            width: 20px;
            height: 20px;
        }
        .bottom-bar span {
            font-size: 10px;
            margin-top: 2px;
        }
        /* å†…å®¹å—ï¼ˆè®°å½•å—çš„å®¹å™¨ï¼‰æ ·å¼ */
        .content {
            padding: 60px 10px 80px; /* ç•™å‡ºé¡¶éƒ¨å’Œåº•éƒ¨ç©ºé—´ */
            max-width: 1200px; /* é™åˆ¶æœ€å¤§å®½åº¦ */
            margin: 0 auto;
            display: grid; /* ä½¿ç”¨ Grid å¸ƒå±€ */
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); /* æ¯ä¸ªè®°å½•å—æœ€å°å®½åº¦300px */
            gap: 10px; /* è®°å½•å—ä¹‹é—´çš„é—´è· */
            justify-content: space-between; /* æ°´å¹³åˆ†æ•£å¯¹é½ */
        }
        /* æ¯ä¸ªè®°å½•å—æ ·å¼ */
        .jilu {
            background: #fff;
            padding: 10px; /* å†…è¾¹è·æ§åˆ¶è®°å½•å—çš„å†…éƒ¨å†…å®¹ä¸è¾¹æ¡†çš„è·ç¦» */
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
            position: relative; /* ä¸ºå³ä¸Šè§’æŒ‰é’®å®šä½æä¾›ä¸Šä¸‹æ–‡ */
            overflow: hidden; /* ç¡®ä¿å­å…ƒç´ æº¢å‡ºéƒ¨åˆ†è¢«è£å‰ª */
            font-size: 14px; /* è®¾ç½®è®°å½•å—ä¸­å†…å®¹çš„å­—ä½“å¤§å° */
        }
        /* è°ƒæ•´è®°å½•å—çš„å®½åº¦ */
        .jilu h3 {
            margin-top: 5px;
            margin-bottom: 10px;
            font-size: 14px; /* æ—¥æœŸå­—ä½“å¤§å° */
            color: #4CAF50;
        }
        .jilu p {
            margin-top: 0px;
            margin-bottom: 5px;
            font-size: 14px; /* è®¾ç½®æè¿°å­—ä½“å¤§å° */
        }

        /* å³ä¸Šè§’æŒ‰é’® */
        .settings-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
        }

        /* è¡¨æ ¼æ ·å¼ */
        table {
            width: 100%; /* è¡¨æ ¼å®½åº¦ä¸ºè®°å½•å—çš„å®½åº¦ */
            table-layout: fixed; /* å›ºå®šåˆ—å®½ */
            border-collapse: collapse; /* å»æ‰å•å…ƒæ ¼ä¹‹é—´çš„ç©ºéš™ */
            border-spacing: 0;
            margin-bottom: 5px;
        }
        table th, table td {
            border: 1px solid #ddd; /* è®¾ç½®å•å…ƒæ ¼çš„è¾¹æ¡† */
            padding: 5px; /* è°ƒæ•´å•å…ƒæ ¼çš„å†…è¾¹è·ä»¥æ§åˆ¶è¡Œé«˜ */
            text-align: center; /* æ–‡æœ¬å±…ä¸­ */
            overflow: hidden; /* è¶…å‡ºéƒ¨åˆ†éšè— */
            white-space: nowrap; /* ç¦æ­¢æ¢è¡Œ */
            font-size: 14px; /* è¡¨æ ¼å†…å®¹å­—ä½“å¤§å° */
        }
        table th {
            background-color: #f2f2f2; /* è¡¨å¤´èƒŒæ™¯é¢œè‰² */
            font-weight: bold; /* è¡¨å¤´å­—ä½“åŠ ç²— */
        }
        /* ç¼©å°æ”¯ä»˜åˆ—çš„å®½åº¦ */
        table th:nth-child(3), table td:nth-child(3) {
            width: 50px; /* è°ƒæ•´æ”¯ä»˜åˆ—çš„å®½åº¦ */
        }
        /* å•å…ƒæ ¼å†…å®¹æ”¯æŒå·¦å³æ»‘åŠ¨ */
        table td div {
            overflow-x: auto; /* æ”¯æŒå·¦å³æ»‘åŠ¨ */
            -ms-overflow-style: none; /* éšè— IE å’Œ Edge çš„æ»šåŠ¨æ¡ */
            scrollbar-width: none; /* éšè— Firefox çš„æ»šåŠ¨æ¡ */
            white-space: nowrap;
        }
        table td div::-webkit-scrollbar {
            display: none; /* éšè— Webkit æ»šåŠ¨æ¡ */
        }

        /* å¤‡æ³¨æ ·å¼ */
        .remark {
            color: #666;
            font-size: 12.5px; /* å¤‡æ³¨å­—ä½“å¤§å° */
            margin-top: 5px;
        }

        /* æœç´¢å¼¹çª—æ ·å¼ */
        .search-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            padding: 20px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            display: none;
            z-index: 1100;
            width: auto;
        }
        .search-popup-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .search-popup input {
            width: 60%;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 5px;
            outline: none;
        }
        .search-popup button {
            padding: 10px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            width: 150px;
        }
        .search-popup button:nth-child(2) {
            background-color: #4CAF50;
            color: white;
        }
        .search-popup button:nth-child(2):hover {
            background-color: #45a049;
        }
        .search-popup button:nth-child(3) {
            background-color: #f44336;
            color: white;
        }
        .search-popup button:nth-child(3):hover {
            background-color: #e53935;
        }

        /* ç¦æ­¢ç‚¹å‡»å…¶ä»–éƒ¨åˆ†çš„é®ç½©å±‚æ ·å¼ */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1099;
            display: none;
        }

        /* å“åº”å¼è°ƒæ•´ï¼šåœ¨ä¸­ç­‰å±å¹•å®½åº¦æ—¶ï¼Œè®°å½•å—æ¯è¡Œå®½åº¦é€‚é… */
        @media (max-width: 768px) {
            .content {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
        }
        /* å“åº”å¼è°ƒæ•´ï¼šåœ¨å°å±å¹•å®½åº¦æ—¶ï¼Œè®°å½•å—æ¯è¡Œä¸€ä¸ª */
        @media (max-width: 480px) {
            .content {
                grid-template-columns: 1fr; /* æ‰‹æœºå±å¹•ä¸€è¡Œä¸€å— */
            }
        }

        /* é€šçŸ¥æ ·å¼ */
        .notification {
            position: fixed;
            right: 20px;
            bottom: 60px;
            background-color: #4CAF50;
            color: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.4s ease, transform 0.4s ease;
            z-index: 1500;
        }
        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
    <div class="top-bar" id="top-title">
        ç”Ÿæ´»äººÂ·è®°å½•
        <img src="zhuye.png" alt="ä¸»é¡µ" onclick="location.href='index.html'"> <!-- æ–°å¢ä¸»é¡µå›¾æ ‡ -->
    </div>

    <!-- ä¸­é—´å†…å®¹æ  -->
    <div class="content" id="records">
        <p>åŠ è½½ä¸­...</p>
    </div>

    <!-- åº•éƒ¨å¯¼èˆªæ  -->
    <div class="bottom-bar">
        <div class="bottom-bar-item" id="search-bar" onclick="toggleSearch()">
            <img src="sousuo.png" alt="æœç´¢" id="search-icon">
            <span id="search-text">æœç´¢</span>
        </div>
        <div class="bottom-bar-item">
            <img src="tongji.png" alt="ç»Ÿè®¡">
            <span>ç»Ÿè®¡</span>
        </div>
    </div>

    <!-- æœç´¢å¼¹çª— -->
    <div class="overlay" id="overlay"></div>
    <div class="search-popup" id="search-popup">
        <div class="search-popup-content">
            <input type="text" id="search-input" placeholder="è¯·è¾“å…¥æœç´¢å…³é”®å­—">
            <button onclick="performSearch()">ç¡®è®¤</button>
            <button onclick="closeSearchPopup()">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- é€šçŸ¥å¼¹çª— -->
    <div class="notification" id="notification">è®°å½•å·²éšè—ï¼</div>

    <script>
        // Firebase é…ç½®å’Œåˆå§‹åŒ–
        const firebaseConfig = {
            apiKey: "AIzaSyB-pZD5Mb8pejzBr3ZuHoFkJipzSWLJCpo",
            authDomain: "jizhang-2e89a.firebaseapp.com",
            databaseURL: "https://jizhang-2e89a-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "jizhang-2e89a",
            storageBucket: "jizhang-2e89a.firebasestorage.app",
            messagingSenderId: "849349607897",
            appId: "1:849349607897:web:e0eb3a2222cac60d3b99c8",
            measurementId: "G-SYL25YT9ZC"
        };

        // åˆå§‹åŒ– Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // è·å–å†…å®¹å®¹å™¨
        const recordsDiv = document.getElementById("records");
        let allRecords = [];

        // æ›´æ–°è®°å½•çš„ state å­—æ®µ
        function updateRecordState(recordId) {
            database.ref(`expenses/${recordId}`).update({ state: "å·²å®Œæˆ" })
                .then(() => {
                    showNotification(); // æ˜¾ç¤ºé€šçŸ¥
                    // æ›´æ–°è®°å½•åˆ—è¡¨ä¸­çš„çŠ¶æ€
                    allRecords = allRecords.map(([id, record]) => {
                        if (id === recordId) {
                            return [id, { ...record, state: "å·²å®Œæˆ" }];
                        }
                        return [id, record];
                    });
                    renderRecords(allRecords);
                })
                .catch((error) => {
                    console.error("æ›´æ–°è®°å½•æ—¶å‘ç”Ÿé”™è¯¯: ", error);
                });
        }

        // æ˜¾ç¤ºé€šçŸ¥å¼¹çª—
        function showNotification() {
            const notification = document.getElementById("notification");
            notification.classList.add("show");
            setTimeout(() => {
                notification.classList.remove("show");
            }, 3000); // æ˜¾ç¤º 3 ç§’é’Ÿåè‡ªåŠ¨éšè—
        }

        // è¯»å–æ•°æ®å¹¶æ¸²æŸ“
        database.ref("expenses").on("value", (snapshot) => {
            const records = snapshot.val();
            if (!records) {
                recordsDiv.innerHTML = "<p>æš‚æ— æ•°æ®ã€‚</p>";
                return;
            }

            allRecords = Object.entries(records)
                .filter(([, record]) => record.state !== "å·²å®Œæˆ" || !record.state) // ç­›é€‰æœªå®Œæˆçš„è®°å½•
                .sort(([, a], [, b]) => {
                    // æŒ‰æ—¥æœŸé™åºæ’åˆ—
                    return new Date(b.date) - new Date(a.date);
                });

            renderRecords(allRecords);
        });

        // æ¸²æŸ“è®°å½•
        function renderRecords(records) {
            recordsDiv.innerHTML = ""; // æ¸…ç©ºä¹‹å‰å†…å®¹
            records.forEach(([id, record]) => {
                const totalMoney = parseFloat(record.money);
                const avgMoney = (totalMoney / parseInt(record.number)).toFixed(2);
                const participants = record.namegive.split(",");

                // æ„å»ºæ”¯ä»˜çŠ¶æ€è¡¨æ ¼
                let tableHTML = `
                    <table>
                        <tr>
                            <th>åˆ†æ‘Šäºº</th>
                            <th>åˆ†æ‘Šé‡‘é¢</th>
                            <th>æ”¯ä»˜</th>
                            <th>ä»˜æ¬¾äºº</th>
                        </tr>
                        <tr>
                            <td><div>${participants.join(",")}</div></td>
                            <td><div>${avgMoney}å…ƒ</div></td>
                            <td><div>â†’</div></td>
                            <td><div>${record.name}</div></td>
                        </tr>
                    </table>
                `;

                // æ„å»ºæ¯æ¡è®°å½•çš„HTMLå—
                const recordElement = document.createElement("div");
                recordElement.classList.add("jilu");
                recordElement.innerHTML = `
                    <button class="settings-btn" onclick="updateRecordState('${id}')">âš™</button>
                    <h3>${record.date}</h3>
                    <p>ğŸ’¡ ${record.name}: ${totalMoney}å…ƒï¼ˆ${record.what || "æ— è¯´æ˜"}ï¼‰</p>
                    ${tableHTML}
                    <p class="remark">å¤‡æ³¨: ${record.why || "æ— å¤‡æ³¨"}</p>
                `;
                recordsDiv.appendChild(recordElement);
            });
        }

        // æœç´¢åŠŸèƒ½
        function toggleSearch() {
            const searchIcon = document.getElementById("search-icon");
            const searchText = document.getElementById("search-text");
            if (searchText.innerText === "æœç´¢") {
                document.getElementById("search-popup").style.display = "block";
                document.getElementById("overlay").style.display = "block";
            } else {
                // å–æ¶ˆæœç´¢
                searchText.innerText = "æœç´¢";
                searchIcon.src = "sousuo.png";
                renderRecords(allRecords); // æ¢å¤æ˜¾ç¤ºæ‰€æœ‰è®°å½•
            }
        }

        function closeSearchPopup() {
            document.getElementById("search-popup").style.display = "none";
            document.getElementById("overlay").style.display = "none";
        }

        function performSearch() {
            const keyword = document.getElementById("search-input").value.trim().toLowerCase();
            if (keyword) {
                const filteredRecords = allRecords.filter(([, record]) => {
                    return Object.values(record).some(value =>
                        value.toString().toLowerCase().includes(keyword)
                    );
                });
                renderRecords(filteredRecords);
                // ä¿®æ”¹æœç´¢å›¾æ ‡å’Œæ–‡å­—
                document.getElementById("search-icon").src = "quxiao.png";
                document.getElementById("search-text").innerText = "å–æ¶ˆ";
            }
            closeSearchPopup();
        }
    </script>
</body>
</html>
